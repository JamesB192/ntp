#! /bin/bash

#  This "bootstrap" script performs various pre-autoreconf actions
#  that are required after pulling fresh sources from the repository.
#
#  NOTE:  THIS FILE DEFINES THE NTP VERSION NUMBER
#
#  all other instances of it anywhere in the source base have propagated
#  from this one source.
#
#  To use the raw sources from the repository, you must have the following
#  tools available to you:
#
#  1.  BitKeeper.  Some of our version information is based on the BitKeeper
#      "prs" command.
#
#  2.  AutoGen.  The repository does *not* contain the files generated from
#      the option definition files and it does not contain the libopts
#      tear-off/redistributable library.
#
#  3.  gunzip.  The tear-off library is a gzipped tarball.
#
#  4.  lynx.  This is used to extract the COPYRIGHT file extracted from
#      the html documentation.
#
#  5.  bash, ksh, zsh or any POSIX compliant shell to run this script.
#
version=4.2.0b

set -e

if (bk version) >/dev/null 2>&1
then
  bk_ver=$(
    test -d "${srcdir}" && cd ${srcdir}
    bk -R prs -hr+ -nd:I: ChangeSet )
  test -f version || touch version
  y=$(<version)
  case "${bk_ver}" in '' | "$y") ;; *) echo ${bk_ver} > version ;; esac
else
  echo ${version} > version
  bk_ver=''
fi

( echo "This file is automatically generated from html/copyright.html"
  lynx -dump html/copyright.html
) > COPYRIGHT.new
mv COPYRIGHT.new COPYRIGHT

rm -rf sntp/libopts*
gunzip -c $(autoopts-config --libsrc) | (
  cd sntp
  tar -xvf -
  mv libopts-*.*.* libopts )
mv -f sntp/libopts/libopts.m4 m4/libopts.m4

prog_opt_files=$(
    egrep -l '^prog.name' $(
        find * -type f -name *.def|fgrep -v /SCCS/))

echo "m4_define([VERSION_NUMBER],[${version}])" > version.m4

echo "version = '${version}';" > include/version.def

incdir=${PWD}/include

for f in ${prog_opt_files}
do
  ( cd $(dirname ${f})
    autogen -L${incdir} $(basename ${f}) )
done

autoreconf -f -i
