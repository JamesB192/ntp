<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html;charset=iso-8859-1">
<title>Mitigation Rules and the prefer Keyword</title>
<link href="scripts/style.css" type="text/css" rel="stylesheet">
</head>
<body>

<h3>Mitigation Rules and the <tt>prefer</tt> Keyword</h3>

<img src="pic/alice11.gif" alt="gif" align="left"><a href="http://www.eecis.udel.edu/%7emills/pictures.html"> from <i>Alice's Adventures in Wonderland</i>, Lewis Carroll</a>
<p>Listen carefully to what I say; it is very complicated.</p>
<p>Last update: 
	<!-- #BeginDate format:En2m -->08-Apr-2009  2:47<!-- #EndDate -->
UTC</p>
<br clear="left">

<h4>Related Links</h4>

<script type="text/javascript" language="javascript" src="scripts/misc.txt"></script>

<h4>Table of Contents</h4>

<ul>

<li class="inline"><a href="#intro">Introduction</a></li>
<li class="inline"><a href="#peer">Peer Classification</a></li>
<li class="inline"><a href="#prefer">The <tt>prefer</tt> Peer</a></li>
<li class="inline"><a href="#miti">Mitigation Rules</a></li>
<li class="inline"><a href="#mins">The <tt>minsane</tt> Option</a></li>

</ul>

<hr>

<h4 id="intro">Introduction</h4>

<p>This page summarizes the criteria for choosing from among a number of potential
	sources suitable contributors to the clock discipline process. The criteria are very meticulous, since they have to handle many different scenarios that may be optimized for peculiar circumstances, including some scenarios designed to support planetary and deep space missions.</p>

<p>Recall the suite of NTP data acquisition and grooming algorithms as these algorithms proceed in five phases. Phase one discovers the available sources and mobilizes an association for each candidate found. These candidates can result from explicit configuration, broadcast discover or the pool and manycast autonomous configuration schemes. Phase two grooms the selectable candidates excluding those sources showing one or more of the following errors</p>

<ol>

<li>A stratum error occurs if (1) the source had never been synchronized or (2) the stratum of the source is below the <tt>floor</tt> option or not below the <tt>ceiling</tt> option specified by the <tt>tos</tt> command. The default value for these options are 0 and 16, respectively.</li>

<li>A distance error occurs for a remote source if the root distance is not below the distance threshold <tt>maxdist</tt> option of the <tt>tos</tt> command. The default value for this option is 1.5 s for networks including only the Earth, but this should be increased to 2.5 s for networks including the Moon.</li>

<li>A loop error occurs if the source is synchronized to the client of if the source is synchronized to the same source as the client.</li>

<li>An unreachable error occurs if the source is unreachable or if the <tt>server</tt> or <tt>peer</tt> command for the source includes the <tt>noselect</tt> option.</li>

</ol>

<p>Phase three uses an intersection algorithm to select the truechimers from among the candidates, leaving behind the falsetickers. Phase four uses a clustering algorithm to cast off statistically insignificant outliers from the truechimers until a set of survivors not less than the number specified as the <tt>minclock</tt> option of the <tt>tos</tt> command, with default 3. Phase five uses a set of mitigation rules to select from among the survivors a system peer from which a set of system statistics can be inherited and passed along to a dependent client population. The system offset developed from these algorithms can discipline the system clock either using the <tt>ntpd</tt> clock discipline algorithm or enable the kernel to discipline the clock directly, as described on the <a href="kern.html">A Kernel Model for Precision Timekeeping</a> page. Phase five is the topic of this page.</p>

<h4 id="peer">Peer Classification</h4>

<p>The behavior of the various algorithms and mitigation rules involved depends on how the various synchronization sources are classified. This depends on whether the source is local or remote and if local the type of source. The following classes are defined:</p>

<ol>

<li>A remote server or peer is classified simply as a server. All others are classified as a device driver of one kind or another. In general, one or more sources of either or both types will be configured in each installation.</li>

<li>If all sources have been lost and the orphan stratum specified by the <tt>orphan</tt> option of the <tt>tos</tt> command, a pseudo-source called the <i>orphan parent</i> is created. Dependent orphan children will see the orphan parent as if synchronized to a primary server at the orphan stratum.</li>

<li>When the PPS Clock Discipline driver (type 22) is configured, it is designated the <i>PPS driver.</i> This driver provides precision clock discipline only within +-0.5 s, so is always associated with another source or sources that provide the seconds numbering function.</li>

<li>When the Undisciplined Local Clock driver (type 1) is configured, it is designated the <i>local driver</i>. This driver is used either as a backup source (stratum greater than zero) should all sources fail, or as the primary source (stratum zero) in cases where the kernel time is disciplined by some other means of synchronization, such as the NIST <tt>lockclock</tt> scheme, or another synchronization protocol such as the Digital Time Synchronization Service (DTSS).</li>

<li>When the Automated Computer Time Service driver (type 18) is configured, it is designated the <i>modem driver</i>. This is used either as a backup source, should all other sources fail, or as the (only) primary source.</li>

</ol>

<h4 id="prefer">The <tt>prefer</tt> Peer</h4>

<p>The mitigation rules are designed to provide an intelligent selection of the system peer from among the survivors of different types. When used with the <tt>server</tt> or <tt>peer</tt>  commands,	the <tt>prefer</tt> option designates one or more survivors as preferred over all others. While the rules do not forbid it, it is usually not useful to designate more than one source as preferred; however, if more than one source is so designated, they are used in the order specified in the configuration file; that is, if the first one becomes unselectable, the second one is used and so forth. This order of priority is also applicable to multiple modem drivers and even multiple local drivers, although that would not normally be useful.</p>

<p>The prefer scheme works on the set of truechimers produced by the intersection algorithms. Ordinarily, any one of them can in principle provide correct time; however, due to various latency variations, not all can provide the most accurate and stable time. The clustering algorithm, which is invoked at this point, operates in one or more rounds to cast off the statistically least significant to the current ensemble until no more than the <tt>minclock</tt> option of the <tt>tos</tt> command are left.</p>

<p>In the prefer scheme the clustering algorithm is modified so that the prefer peer is never discarded; on the contrary, its potential removal becomes a rounds-termination condition. However, the prefer peer can still be discarded by the intersection algorithm as a falseticker. To avoid this, it is usually wise to increase the <tt>mindist</tt> option of the <tt>tos</tt> command from the default .005 s to something like .05 s. s.</p>

<p>Along with this behavior, the clock selection procedures are modified so that the combining algorithm is not used when a prefer peer is present. Instead, the offset of the prefer peer is used exclusively as the synchronization source. In the usual case involving a radio clock and a flock of remote stratum-1 peers, and with the radio clock designated a prefer peer, the result is that the high quality radio time disciplines the server clock as long as the radio itself remains operational and with valid time, as determined from the remote peers, sanity checks and intersection algorithm.</p>

<h4 id="miti">Mitigation Rules</h4>

<p>As the selection algorithm scans the associations for selectable candidates, the modem driver, local driver and PPS driver, are segregated for later, but only if not designated a prefer peer. If so designated, a driver is included among the selectable candidate population along with the others. In addition if orphan servers are found the parent with the lowest distnace is segregated for later; the others are discarded. Here, distance is defined as the IPv4 address of the first four octets of the hashed IPv6 address. The resulting candidates, including the first prefer peer found, are processed by the intersection and clustering algorithms to yield a possibly empty set of survivors. The clustering algorithm ranks the survivors by synchronization distance and designates the survivor with the lowest distance as the potential system peer.</p>

<p>The mitigation algorithm proceeds in three steps in turn.</p>

<ol>

<li>If there are no survivors, the modem driver becomes the only survivor if there is one. If not, the orphan parent becomes the only survivor if there is one. If not, the local driver becomes the only survivor if there is one. If the number of survivors at this point is less than the <tt>minsane</tt> option of the <tt>tos</tt> command, the algorithm is terminated and the system variables remain unchanged. Note that <tt>minsane</tt> is by default 1, but can set at any value including 0.</li>

<li>If the only survivor is the orphan parent, it becomes the system peer and its clock offset and jitter are inherited by the corresponding system variables. Note that by design all the orphan children sharing the same set of potential orphan parents will select the same parent. Otherwise, if the prefer peer is among the survivors, it becomes the system peer and its clock offset and jitter are inherited by the corresponding system variables. If not, the combining algorithm computes these variables from the survivor population.</li>

<li>If there is a PPS driver and the system clock offset produced in step two is less than 0.4 s, the PPS driver is selectable and operation continues in two contingencies. If there is a prefer peer, or if overridden by the <tt>flag1</tt> option of the <tt>fudge</tt> command for the PPS driver, the PPS driver becomes the system peer and its offset and jitter are inherited by the system variables.</li>

</ol>

<p>If none of the above is the case, the data are disregarded and the system variables remain as they are.</p>

<h4 id="mins">The <tt>minsane</tt> Option</H4>

<p> The <tt>minsane</tt> option of the <tt>tos</tt> command, the <tt>prefer</tt> option of the <tt>server</tt> and <tt>peer</tt> commands and the <tt>flag1</tt> option of the <tt>fudge</tt> command for the PPS driver can be used in conjunction with the mitigation rules to provide many useful configurations. The <tt>minsane</tt> option specifies the minimum number of survivors required to synchronized the system clock. The <tt>prefer</tt> option designates the prefer peer. The <tt>flag1</tt> option enables the PPS driver even if no prefer peer is available.</p>

<p>In the intended mode of operation, a GPS clock driver is configured along with the PPS driver and the GPS driver set as the prefer peer. If the serial timecode of the GPS driver is within 0.4 s of the PPS driver, the PPS driver disciplines the system clock. If no GPS satellites are in view, or if the antenna is disconnected, this condition is visible to the GPS driver, which then indicates this by ceasing updates to the <tt>ntpd</tt> daemon. The result is that the GPS driver becomes unreachable and in turn the PPS driver is disabled. This is the preferred behavior, as the holdover stability of the PPS signal from the GPS receiver is no better than the system clock stability.</p>

<p>As in the above scenario, if the <tt>minsane</tt> option is set to 0 and there is a prefer peer, it can be used in the same manner. However, this would normally disable the PPS driver if the prefer peer were to become unavailable. This behavior can be altered with the <tt>flag1</tt> option for the PPS driver. In the default case (dim) the behavior is as above; if lit, the prefer peer is disregarded and the PPS driver is enabled no matter what the state of the prefer peer or if there is no designated prefer peer.</p>

<p>A scenario where the latter behavior can be most useful is for a planetary
	orbiter fleet, for instance in the vicinity of Mars, where contact between
	orbiters is only one or two times per Sol (Mars day). These orbiters have a
	precise timing reference based on a Ultra Stable Oscillator (USO) with accuracy
	in the order of a Cesium oscillator. A PPS signal is derived from the USO and
	can be disciplined from Earth on rare occasion or from another orbiter via NTP.
	In the above scenario the PPS signal disciplines the spacecraft clock between
	NTP updates.</p>

<p>In a similar scenario a PPS signal can be used to discipline the clock between
	updates produced by the modem driver. This would provide precise synchronization
	without needing the Internet at all.</p>

<hr>
<script type="text/javascript" language="javascript" src="scripts/footer.txt"></script>
	</body>

</html>