<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>

	<head>
		<meta http-equiv="content-type" content="text/html;charset=iso-8859-1">
		<meta name="generator" content="HTML Tidy, see www.w3.org">
		<title>ntp-keygen - generate public and private keys</title>
		<link href="scripts/style.css" type="text/css" rel="stylesheet">
	</head>

	<body>
		<h3><tt>ntp-keygen</tt> - generate public and private keys</h3>
		<img src="pic/alice23.gif" alt="gif" align="left"><a href="http://www.eecis.udel.edu/%7emills/pictures.html">from <i>Alice's Adventures in Wonderland</i>, Lewis Carroll</a>
		<p>Alice holds the key.</p>
		<p>Last update: <csobj format="ShortTime" h="25" locale="00000409" region="0" t="DateTime" w="61">02:48</csobj> UTC <csobj format="LongDate" h="25" locale="00000409" region="0" t="DateTime" w="301">Monday, September 10, 2007</csobj></p>
		<br clear="left">
		<h4>Related Links</h4>
		<script type="text/javascript" language="javascript" src="scripts/links9.txt"></script>
		<h4>Table of Contents</h4>
		<ul>
			<li class="inline"><a href="#synop">Synopsis</a>
			<li class="inline"><a href="#descrip">Description</a>
			<li class="inline"><a href="#run">Running the program</a>
			<li class="inline"><a href="#trust">Trusted Hosts and Secure Groups</a>
			<li class="inline"><a href="#ident">Identity Schemes</a>
			<li class="inline"><a href="#cmd">Command Line Options</a>
			<li class="inline"><a href="#rand">Random Seed File</a>
			<li class="inline"><a href="#fmt">Cryptographic Data Files</a>
			<li class="inline"><a href="#bug">Bugs</a>
		</ul>
		<hr>
		<h4 id="synop">Synopsis</h4>
		<p id="intro"><tt>ntp-keygen [ -cdeMPT ] [ -c [RSA-MD2 | RSA-MD5 | RSA-SHA | RSA-SHA1 | RSA-MDC2 | RSA-RIPEMD160 | DSA-SHA | DSA-SHA1 ] ] [ -H&nbsp;} [ -i <i>issuername</i> ] [ -p <i>passwd2</i> ] [ -q <i>passwd1</i> ] [ -S [ RSA | DSA ] ] [ -s <i>subjectame</i> ] [ -V <i>nkeys</i> ]</tt></p>
		<h4 id="descrip">Description</h4>
		<p>This program generates cryptographic data files used by the NTPv4 authentication and identity schemes. It generates MD5 key files used in symmetric key cryptography and, if the OpenSSL software library has been installed, it generates encryption keys, certificates and identity parameters used by the Autokey cryptographic algorithms. All files are in PEM-encoded printable ASCII format, so they can be embedded as MIME attachments in mail to other sites and certificate authorities.</p>
		<p>Generated files are compatible with other OpenSSL applications and other Public Key Infrastructure (PKI) resources. Certificates or certificate requests generated by this or other programs should be compatible with extant industry practice, although some users might find the interpretation of X509v3 extension fields somewhat liberal. However, the identity parameter files are probably not compatible with anything other than Autokey.</p>
		<p>All files written by this program are encrypted using a private password. The <tt>-p <i>passwd2</i></tt> option specifies the write password and the <tt>-q <i>passwd2</i></tt> option the read password for previously encrypted files. If no read password is specified, the host name returned by the Unix <tt>gethostname()</tt> function is used. If no write password is specified, the read password is used as the write password.</p>
		<p>The <tt>ntpd</tt> configuration command <tt>crypto pw <i>passwd</i></tt> specifies the read password for previously encrypted files. The daemon expires on the spot if a file fails to decrypt properly. For convenience, if the <tt>ntpd</tt> password is not specified, the host name returned by the Unix <tt>gethostname()</tt> function is used. Thus, if files are generated by this program without password, they can be read back by <tt>ntpd</tt> without password, but only on the same machine.</p>
		<p>All files and links are installed by default in the keys directory <tt>/usr/local/etc</tt>, which is normally in a shared filesystem in NFS-mounted networks. The actual location of the keys directory can be changed by a configuration command. Normally, the files for each host are generated by that host and used only by that host, although exceptions exist as noted later on this page.</p>
		<p>File and link names are in the form <tt>ntpkey_<i>key</i>_<i>name</i>.<i>fstamp</i></tt>, where <tt><i>key</i></tt> is the key type, <tt><i>name</i></tt> is the host or group name and <tt><i>fstamp</i></tt> is the filestamp (NTP&nbsp;seconds) when the file was created. The key type is a string defining the cryptographic function as described in the command line options below. The filestamp is not used in generated link names. Key types include <tt>host</tt>, <tt>sign</tt>, certificate <tt>cert</tt> and several challenge/response key types. By convention, files used for challenges have a <tt>par</tt> subtype, as in the IFF&nbsp;challenge <tt>iffpar</tt>, while files for responses have a <tt>key</tt> subtype, as in the GQ response  <tt>gqkey</tt>.</p>
		<h4 id="run">Running the Program</h4>
		<p>For conciseness in the following discussion, only the key type portion of the name is used and the prefix and suffix are omitted. The safest way to run this program is log in as root and change to the keys directory, usually <tt>/usr/local/etc. </tt>When run for the first time, or if all <tt>ntpkey</tt> files have been removed, use the</p>
		<p><tt>ntp-keygen -q <i>passwd1</i></tt></p>
		<p>command, where <tt><i>passwd1</i></tt> is the password also used by <tt>ntpd</tt>. All  <tt>ntp-keygen </tt>commands must include the <tt>-q <i>passwd1</i></tt> as the explicit read password and implicit write password.</p>
		<p>The program generates an RSA host key file <tt>RSAkey </tt>and link <tt>host</tt>, and matching RSA-MD5 certificate file <tt>RSA-MD5cert</tt> and link <tt>cert</tt>. This is all that is necessary for the Trusted Certificate (TC) identity scheme, which does not use a challenge/response identity scheme. Identity schemes will be described later. If run again with the same command line, the program uses the same host key file, but generates a new certificate file and link. Include the <tt>-H </tt>option to generate all new files and links.</p>
		<p>Run the command on as many machines as necessary. Designate one of them the trusted host and configure it to synchronize via reliable paths. Then configure the nontrusted servers to synchronize s to the trusted host directly or indirectly but avoid cyclic paths.</p>
		<p>By default the name used in the host key and certificate file is the string returned by the Unix <tt>gethostname()</tt>&nbsp;function. A different name can be assigned using the <tt>-s <i>host</i></tt> option on the command line. The name must match the <tt>host</tt> name specified in the <tt>crypto</tt> command in the configuration file. The host key is used to encrypt the cookie when required and so must be RSA type. By default, the host key is also the sign key used to encrypt signatures. A different sign key file name can be assigned using the <tt>-S <i>sign</i></tt> option and this can be either RSA or DSA type. By default, the message digest type is MD5, but any combination of sign key type and message digest type supported by the OpenSSL library can be specified.</p>
		<h4 id="trust">Trusted Hosts and Secure Groups</h4>
		<p>As described on the <a href="authopt.html">Authentication Options</a> page, an NTP&nbsp;secure group consists of one or more low-stratum trusted hosts as the root from which all other group hosts derive synchronization directly or indirectly via acyclic certificate trails. For cryptographic purposes all trusted hosts in a group have the same name, which is also the name of the group. Trusted hosts have trusted, self-signed certificates; all other hosts have nontrusted, self-signed certificates. A certificate trail is constructed by asking the immediately ascendant host toward the root to sign its certificate, which is then provided to the immediately descendant host on request.</p>
		<p>It is convenient to nominate a single trusted host acting as a trusted authority (TA) to generate a set of files that are then copied intact to all other trusted hosts in the group, most conveniently as a tar archive. This means that it doesn't matter which certificate trail ends at which trusted host, since the rootcertificate and identity data are the same. To generate and install cryptographic media files on the TA as root, use the <tt>-s <i>host</i></tt> option to specify the host name and the <tt>-T</tt> option to specify a trusted certificate.  If run again with the same command line, the program uses the same host key file, but generates a new certificate file and link. Include the <tt>-H </tt>option to generate all new files and links.</p>
		<p>To generate and install cryptgrahic media files on nontrusted hosts as root, use the <tt>-i <i>group</i></tt> option to specify the group name and nontrusted certificate. This option has no effect unless one of the identity schemes described in the next section is used, but it does help to minimize errors when configuriong certificate trails.</p>
		<h4 id="ident">Identity Schemes</h4>
		<p>As described on the <a href="authopt.html">Authentication Options</a> page, there are five identity schemes, three of which, IFF, GQ and MV, have password protected identity files. A file specific to each scheme and group is generated by the TA and then copied to all trusted hosts. In the intended model a group host sends a mail request message to the TA including its private key. The TA encrypts the identity file with that key an returns it in a mail message. The attachment is then copied intact to the keys director and renamed as directed below.</p>
		<p>Use the following procedure to produce IFF parameters for nontrusted group hosts. The procedure is similar for the GQ parameters. The TA uses the</p>
		<p><tt>intp-keygen -q <i>passwd1</i> -p <i>passwd2 </i>-i <i>group</i></tt></p>
		<p>command to generate IFF&nbsp;parameters, where <tt><i>passwd1</i></tt> is the trusted host password and <tt><i>passwd2</i></tt> is the intended recipient password and must be different from <tt><i>passwd1</i></tt>. The particular identity scheme selected and the parmeter file type will match the scheme selected by the TA when first generating its own files.</p>
		<p>The group&nbsp;parameters are written to the standard output stream <tt>stdout<i> </i></tt>where they can be piped to an application that sends the contents to the intended recipient as a MIME&nbsp;attachment. The identity parameters are installed in the keys directory and renamed as in the first line of the file, but without the filestamp.</p>
		<p>The NTP&nbsp;secure group rules require that a all hsts have the same name; however, a trusted host can be a client of one or more other groups operating at a lower stratum. The trusted host or hosts have identity keys for their group as well as identity parameters for each of the lower stratum groups. These parameters can be obtained from the TA&nbsp;of each group.</p>
		<p>During the Autokey protocol with the selected lower stratum hosts, the trusted host hikes the certificate trail to obtain and install the trusted host certificate of the lower stratum group. The subject name on this certificate is used to load the identity parameters for that group.</p>
		<p>In the IFF scheme the TA&nbsp;generates the IFF key file including a private key and the parameters needed to verify identity to a dependent client. The parameter file is normally a copy of this file; however, using the <tt>-e</tt> option on the <tt>ntp-keygen</tt> command line, the parameter file includes only the parameters and not the private key. A client without the private key cannot prove identity to dependent client.</p>
		<p>In the GQ scheme the TA&nbsp;generates the key and parameter files in  separate steps and provides only the parameter file to other group hosts. However, any host can use <tt>ntp-keygen</tt> to create a new GQ key file to prove identity to dependent client.</p>
		<h4 id="cmd">Command Line Options</h4>
		<dl>
			<dt><tt>-c [ RSA-MD2 | RSA-MD5 | RSA-SHA | RSA-SHA1 | RSA-MDC2 | RSA-RIPEMD160 | DSA-SHA | DSA-SHA1 ]</tt>
			<dd>Select certificate and message digest/signature encryption scheme. Note that RSA schemes must be used with a RSA sign key and DSA schemes must be used with a DSA sign key. The default without this option is <tt>RSA-MD5</tt>.
			<dt><tt>-d</tt>
			<dd>Enable debugging. This option displays the cryptographic data produced for eye-friendly billboards.<dt><tt>-e</tt>
			<dd>Generate IFF parameter file <tt>IFFpar</tt> from an existing IFF key file <tt>IFFkey</tt>. This is commonly done to produce IFF parameters for hosts acting only as clients without revealing the private key. Note: This option is active only when the write password is different than the read password.<dt><tt>-G</tt>
			<dd>Generate GQ&nbsp;key file <tt>GQkey </tt>and link <tt>gqkey </tt>for the Guillou-Quisquater (GQ) identity scheme, obsoleting any that may exist.
			<dt><tt>-g</tt>
			<dd>Generate GQ&nbsp;parameter file <tt>GQpar </tt>for the Guillou-Quisquater (GQ) identity scheme, obsoleting any that may exist. This option is normally used when the read pasword and write password are different.
			<dt><tt>-H</tt>
			<dd>Generate public/private host keys <tt>RSAkey</tt>, and link <tt>host, </tt>obsoleting any that may exist.<dt><tt>-I</tt>
			<dd>Generate parameters <tt>IFFpar </tt>and link <tt>iff </tt>for the Schnorr (IFF) identity scheme, obsoleting any that may exist.<dt><tt>-i <i>name</i></tt>
			<dd>Set the group name to <tt><i>name</i></tt>. This is used as the file name for identity parameters. If this option is not present, the group name defaults to the host name.<dt><tt>-M</tt>
			<dd>Generate MD5 keys, obsoleting any that may exist.
			<dt><tt>-P</tt>
			<dd>Generate a private certificate used by the PC identity scheme. By default, the program generates public certificates.<dt><tt>-p <i>password</i></tt>
			<dd>Set the password for writing encrypted files to <tt><i>password</i></tt>.<dt><tt>-q <i>password</i></tt>
			<dd>Set the password for reading encrypted files to <tt><i>password</i></tt>.
			<dt><tt>-S [ RSA | DSA ]</tt>
			<dd>Generate a new sign key of the designated type, obsoleting any that may exist. By default, the program uses the host key as the sign key.
			<dt><tt>-s <i>name</i></tt>
			<dd>Set the host name to <tt><i>name</i></tt>. This is used for the host key as well as the subject and issuer names in certificates.<dt><tt>-T</tt>
			<dd>Generate a trusted certificate. By default, the program generates a non-trusted certificate.
			<dt><tt>-V <i>nkeys</i></tt>
			<dd>Generate server parameters <tt>MV</tt> and <tt><i>nkeys</i></tt> client keys for the Mu-Varadharajan (MV)  identity scheme. Note: support for this option should be considered a work in progress.</dl>
		<h4 id="rand">Random Seed File</h4>
		<p>All cryptographically sound key generation schemes must have means to randomize the entropy seed used to initialize the internal pseudo-random number generator used by the OpenSSL library routines. If a site supports <tt>ssh</tt>, it is very likely that means to do this are already available. The entropy seed used by the OpenSSL library is contained in a file, usually called <tt>.rnd</tt>, which must be available when starting the <tt>ntp-keygen</tt> program or <tt>ntpd</tt> daemon.</p>
		<p>The OpenSSL library looks for the file using the path specified by the <tt>RANDFILE</tt> environment variable in the user home directory, whether root or some other user. If the <tt>RANDFILE</tt> environment variable is not present, the library looks for the <tt>.rnd</tt> file in the user home directory. Since both the <tt>ntp-keygen</tt> program and <tt>ntpd</tt> daemon must run as root, the logical place to put this file is in <tt>/.rnd</tt> or <tt>/root/.rnd</tt>. If the file is not available or cannot be written, the program exits with a message to the system log.</p>
		<h4 id="priv">Cryptographic Data Files</h4>
		<p>All file formats begin with two lines. The first line contains the file name, in the format <tt>ntpkey_<i>key</i>_<i>host</i>.<i>fstamp</i></tt>, where <tt><i>key</i></tt> is the key type, <tt><i>host</i></tt> is the group or host name and <tt><i>fstamp</i></tt> is the filestamp (NTP seconds) when the file was created. The second line contains the datestamp in conventional Unix <tt>date</tt> format. Lines beginning with <tt>#</tt> are ignored.</p>
		<p>The remainder of the file contains cryptographic data encoded first using ASN.1 rules, then encrypted using the DES-CBC algorithm and given password and finally written in PEM-encoded printable ASCII text preceded and followed by MIME content identifier lines.</p>
		<p id="symkey">The format of the symmetric keys file is somewhat different than the other files in the interest of backward compatibility. Since DES-CBC is deprecated in NTPv4, the only key format of interest is MD5 alphanumeric strings. Following the header the keys are entered one per line in the format</p>
		<p><i><tt>keyno type key</tt></i></p>
		<p>where <i><tt>keyno</tt></i> is a positive integer in the range 1-65,535, <i><tt>type</tt></i> is the string <tt>MD5</tt> defining the key format and <i><tt>key</tt></i> is the key itself, which is a printable ASCII string 16 characters or less in length. Each character is chosen from the 93 printable characters in the range 0x21 through 0x7f excluding space and the '#' character.</p>
		<p>Note that the keys used by the <tt>ntpq</tt> and <tt>ntpdc</tt> programs are checked against passwords requested by the programs and entered by hand, so it is generally appropriate to specify these keys in human readable ASCII format.</p>
		<p>The <tt>ntp-keygen</tt> program generates a MD5 symmetric keys file <tt>ntpkey_MD5key_<i>hostname.filestamp</i></tt>. Since the file contains private shared keys, it should be visible only to root and distributed by secure means to other subnet hosts. The NTP daemon loads the file <tt>ntp.keys</tt>, so <tt>ntp-keygen</tt> installs a soft link from this name to the generated file. Subsequently, similar soft links must be installed by manual or automated means on the other subnet hosts. While this file is not used with the Autokey Version 2 protocol, it is needed to authenticate some remote configuration commands used by the <a href="ntpdc.html"><tt>ntpq</tt></a> and <a href="ntpq.html"><tt>ntpdc</tt></a> utilities.</p>
		<h4 id="bug">Bugs</h4>
		<p>It can take quite a while to generate some cryptographic values, from one to several minutes with modern architectures such as UltraSPARC and up to tens of minutes to an hour with older architectures such as SPARC IPC.</p>
		<hr>
		<script type="text/javascript" language="javascript" src="scripts/footer.txt"></script>
	</body>

</html>