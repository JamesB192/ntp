<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>

	<head>
		<meta http-equiv="content-type" content="text/html;charset=iso-8859-1">
		<meta name="generator" content="HTML Tidy, see www.w3.org">
		<title>ntp-keygen - generate public and private keys</title>
		<link href="scripts/style.css" type="text/css" rel="stylesheet">
	</head>

	<body>
		<h3><tt>ntp-keygen</tt> - generate public and private keys</h3>
		<img src="pic/alice23.gif" alt="gif" align="left"><a href="http://www.eecis.udel.edu/%7emills/pictures.html">from <i>Alice's Adventures in Wonderland</i>, Lewis Carroll</a>
		<p>Alice holds the key.</p>
		<p>Last update: <csobj format="ShortTime" h="25" locale="00000409" region="0" t="DateTime" w="61">17:16</csobj> UTC <csobj format="LongDate" h="25" locale="00000409" region="0" t="DateTime" w="301">Monday, September 17, 2007</csobj></p>
		<br clear="left">
		<h4>Related Links</h4>
		<script type="text/javascript" language="javascript" src="scripts/links9.txt"></script>
		<h4>Table of Contents</h4>
		<ul>
			<li class="inline"><a href="#synop">Synopsis</a>
			<li class="inline"><a href="#descrip">Description</a>
			<li class="inline"><a href="#run">Running the program</a>
			<li class="inline"><a href="#trust">Trusted Hosts and Secure Groups</a>
			<li class="inline"><a href="#ident">Identity Schemes</a>
			<li class="inline"><a href="#cmd">Command Line Options</a>
			<li class="inline"><a href="#rand">Random Seed File</a>
			<li class="inline"><a href="#fmt">Cryptographic Data Files</a>
			<li class="inline"><a href="#bug">Bugs</a>
		</ul>
		<hr>
		<h4 id="synop">Synopsis</h4>
		<p id="intro"><tt>ntp-keygen [ -cdeMPT ] [ -c [RSA-MD2 | RSA-MD5 | RSA-SHA | RSA-SHA1 | RSA-MDC2 | RSA-RIPEMD160 | DSA-SHA | DSA-SHA1 ] ] [ -H&nbsp;} [ -i <i>issuername</i> ] [ -p <i>passwd2</i> ] [ -q <i>passwd1</i> ] [ -S [ RSA | DSA ] ] [ -s <i>subjectame</i> ] [ -V <i>nkeys</i> ]</tt></p>
		<h4 id="descrip">Description</h4>
		<p>This program generates cryptographic data files used by the NTPv4 authentication and identity schemes. It generates MD5 keys used in symmetric key cryptography and, if the OpenSSL software library has been installed, it generates encryption keys, certificates and identity keys used in the Autokey public key cryptography. All files are in PEM-encoded printable ASCII format so they can be embedded as MIME attachments in mail to other sites and certificate authorities.</p>
		<p>Generated files are compatible with other OpenSSL applications and other Public Key Infrastructure (PKI) resources. Certificates or certificate requests generated by this or other programs should be compatible with extant industry practice, although some users might find the interpretation of X509v3 extension fields somewhat liberal. However, the identity keys files are probably not compatible with anything other than Autokey.</p>
		<p>Most files written by this program are encrypted using a private password. The <tt>-p <i>passwd2</i></tt> option specifies the write password and the <tt>-q <i>passwd2</i></tt> option the read password for previously encrypted files. If no read password is specified, the host name returned by the Unix <tt>gethostname()</tt> function is used. If no write password is specified, the read password is used as the write password.</p>
		<p>The <tt>ntpd</tt> configuration command <tt>crypto pw <i>passwd</i></tt> specifies the read password for previously encrypted files. This must match the write password used by this program. For convenience, if the <tt>ntpd</tt> password is not specified, the host name returned by the Unix <tt>gethostname()</tt> function is used. Thus, if files are generated by this program without password, they can be read back by <tt>ntpd</tt> without password, but only on the same host.</p>
		<p>All files and links are installed by default in the keys directory <tt>/usr/local/etc</tt>, which is normally in a shared filesystem in NFS-mounted networks. The location of the keys directory can be changed by the <tt>keysdir</tt> configuration command. Normally, encrypted  files for each host are generated by that host and used only by that host, although exceptions exist as noted later on this page.</p>
		<p>This program directs commentary and error messages to the standard error stream <tt>stderr</tt> and some files to the standard output stream <tt>stdout</tt> where they can be piped to other aplications or redirected to a file. The names used for generated files and links all begin with the string <tt>ntpkey</tt> and include the file type, generating host and filestamp, as described in the <a href="#fmt">Cryptographic Data Files</a> section below</p>
		<h4 id="run">Running the Program</h4>
		<p>The safest way to run this program is log in as root and change to the keys directory, usually <tt>/usr/local/etc. </tt>When run for the first time, or if all files with names beginning <tt>ntpkey</tt> have been removed, use the <tt>ntp-keygen </tt>command without arguments to generate a default RSA host key file and matching RSA-MD5 certificate file. The file names and password default to the host name as described above. If run again with the same command line, the program uses the same host key file, but generates a new certificate file.</p>
		<p>Run the command on as many hosts as necessary. Designate one of them as the trusted host (TH) using the <tt>-T</tt> option on the command line and configure it to synchronize via reliable paths. THs have trusted, self-signed certificates; all other hosts have nontrusted, self-signed certificates. Then configure the nontrusted hosts to synchronize to the TH directly or indirectly. A certificate trail is created by asking the immediately ascendant host towards the root to sign its certificate, which is then provided to the immediately descendant host on request. All group hosts should have acyclic certificate trails ending on the TH.</p>
		<p>By default the name used in the subject and issuer fields in the certificate is the host name. A different name can be assigned using the <tt>-s <i>host</i></tt> option on the command line, but the name must match the host name specified by the <tt>crypto</tt> configuration command.</p>
		<p>The host key is used to encrypt the cookie when required and so must be RSA type. By default, the host key is also the sign key used to encrypt signatures. A different sign key file name can be assigned using the <tt>-S</tt> option and this can be either RSA or DSA type. By default, the message digest type is MD5, but any combination of sign key type and message digest type supported by the OpenSSL library can be specified.</p>
		<h4 id="trust">Trusted Hosts and Secure Groups</h4>
		<p>As described on the <a href="authopt.html">Authentication Options</a> page, an NTP&nbsp;secure group consists of one or more low-stratum THs as the root from which all other group hosts derive synchronization directly or indirectly. For authentication purposes all THs in a group must have the same host and gtoup name; all other hosts have the same group name, but different host names. The host name and group name must match the names specified by the <tt>crypto</tt> configuratrion command. Host and group names are used only for authentication purposes and have nothing to do with DNS&nbsp;names.</p>
		<p>It is convenient to nominate a single TH acting as a trusted authority (TA) to generate a set of files and links that are then copied intact to all other THs in the group, most conveniently as a tar archive. This means that it doesn't matter which certificate trail ends at which TH, since the cryptographic media are the same.</p>
		<p>To generate and install cryptographic media files, The TA&nbsp;uses the</p>
		<p><tt>ntp-keygen -q <i>passwd</i> -s <i>host -</i>T</tt></p>
		<p>command to specify the password, host/group name and trusted certificate. For THs the host and group names are the same and must match the host and group names specified on the <tt>crypto</tt> configuration command. If run again with the same command line, the program uses the same host key file, but generates a new trusted certificate file. Group hosts other than the THs use the same command line, but with a different host name and without the <tt><i>-</i>T</tt> option. On these hosts if the <tt>-s <i>host</i></tt> option is missing, the host name is the default described above.</p>
		<h4 id="ident">Identity Schemes</h4>
		<p>As described on the <a href="authopt.html">Authentication Options</a> page, there are five identity schemes, three of which - IFF, GQ and MV - require files specific to each scheme and group. There are two files for each scheme, an encrypted keys file and a nonencrypted parameters file. THs need only the keys file; all the others need the parameters file. Other hosts expecting to support a client population also need the keys file; hosts acting only as clients need only the parameters file. Both files are generated by the TA on behalf of all servers and clients in the group.</p>
		<p>The parameters files are public; they can be stored in a public place and sent in the clear. The keys files are encrypted with the host read password. To retrieve the keys file, a host sends a mail request to the TA including its private read password. The TA encrypts the keys file with this password and returns it as an attachment. The attachment is then copied intact to the keys directory with name given in the first line of the file, but all in lower case and with the filestamp deleted..</p>
		<p>The TA can generate GQ&nbsp;keys, certificate and identity files for all THs using the command</p>
		<p><tt>ntp-keygen -q <i>passwd</i> -s <i>host </i>-T&nbsp;-G -e &gt;<i>parameters_file</i></tt></p>
		<p>where the the redirected <tt><i>parameters_file</i></tt> can be piped to a mail application or stored locally and renamed as above for later distribution. The procedure for IFF&nbsp;files is similar with <tt>-G</tt> replaced by <tt>-I</tt>.</p>
		<p>The TA&nbsp;can generate an encrypted GQ keys file copy using the command</p>
		<p><tt>ntp-keygen -q <i>passwd1</i> -p <i>passwd2 </i>-s <i>host </i>&gt;<i>keys_file</i></tt></p>
		<p>where <tt><i>passwd1</i></tt> is the read password for the TA, <tt><i>passwd2</i></tt> is the read password for the requesting host and <tt><i>keys_file</i></tt> is sent or stored as above. The program uses the keys and parameters of whatever scheme generated the keys file.</p>
		<p><tt><i> </i></tt></p>
		<h4 id="cmd">Command Line Options</h4>
		<dl>
			<dt><tt>-c [ RSA-MD2 | RSA-MD5 | RSA-SHA | RSA-SHA1 | RSA-MDC2 | RSA-RIPEMD160 | DSA-SHA | DSA-SHA1 ]</tt>
			<dd>Select certificate and message digest/signature encryption scheme. Note that RSA schemes must be used with a RSA sign key and DSA schemes must be used with a DSA sign key. The default without this option is <tt>RSA-MD5</tt>.
			<dt><tt>-d</tt>
			<dd>Enable debugging. This option displays the cryptographic data produced for eye-friendly billboards.<dt><tt>-e</tt>
			<dd>Generate unencrypted IFF or GQ parameters file from existing key file <tt>IFFkey</tt>. or <tt>GQkey</tt>  file, respectively. The file contents are sent to the standard output stream <tt>stdout</tt>..<dt><tt>-G</tt>
			<dd>Generate GQ&nbsp;key file <tt>GQkey </tt>and link <tt>gqkey </tt>for the Guillou-Quisquater (GQ) identity scheme.
			<dt><tt>-H</tt>
			<dd>Generate a new public/private host keys <tt>RSAkey</tt>, and link <tt>host</tt>.
			<dt><tt>-I</tt>
			<dd>Generate a new encrypted IFF key file <tt>IFFkey </tt>and link <tt>iffkey </tt>for the Schnorr (IFF) identity scheme.<dt><tt>-i <i>group</i></tt>
			<dd>Set the group name to <tt><i>group</i></tt> for generated identity files. This is useful only if the TA&nbsp;is not a group member and is generally considered not a good practice.<dt><tt>-M</tt>
			<dd>Generate a new MD5 key file.<dt><tt>-P</tt>
			<dd>Generate a new private certificate used by the PC identity scheme. By default, the program generates public certificates. Note: the PC&nbsp;identity scheme is not recommended for new installations.<dt><tt>-p <i>passwd</i></tt>
			<dd>Set the password for writing encrypted files to <tt><i>passwd</i></tt>. By default, the write password is the read password.<dt><tt>-q <i>passwd</i></tt>
			<dd>Set the password for reading encrypted files to <tt><i>passwd</i></tt>. By default,  the read password is the host name.<dt><tt>-S [ RSA | DSA ]</tt>
			<dd>Generate a new sign key of the designated type. By default, the sign key is the host key.<dt><tt>-s <i>name</i></tt>
			<dd>Set the host name to <tt><i>name</i></tt>. This is used in the host and sign key file names, as well as the subject and issuer names in the certificate. It must match the host name specified in the <tt>CRYPTO</tt>&nbsp;configuration command. <dt><tt>-T</tt>
			<dd>Generate a trusted certificate. By default, the program generates nontrusted certificates.<dt><tt>-V <i>nkeys</i></tt>
			<dd>Generate server parameters <tt>MV</tt> and <tt><i>nkeys</i></tt> client keys for the Mu-Varadharajan (MV)  identity scheme. Note: support for this option should be considered a work in progress.</dl>
		<h4 id="rand">Random Seed File</h4>
		<p>All cryptographically sound key generation schemes must have means to randomize the entropy seed used to initialize the internal pseudo-random number generator used by the OpenSSL library routines. If a site supports <tt>ssh</tt>, it is very likely that means to do this are already available. The entropy seed used by the OpenSSL library is contained in a file, usually called <tt>.rnd</tt>, which must be available when starting the <tt>ntp-keygen</tt> program or <tt>ntpd</tt> daemon.</p>
		<p>The OpenSSL library looks for the file using the path specified by the <tt>RANDFILE</tt> environment variable in the user home directory, whether root or some other user. If the <tt>RANDFILE</tt> environment variable is not present, the library looks for the <tt>.rnd</tt> file in the user home directory. Since both the <tt>ntp-keygen</tt> program and <tt>ntpd</tt> daemon must run as root, the logical place to put this file is in <tt>/.rnd</tt> or <tt>/root/.rnd</tt>. If the file is not available or cannot be written, the program exits with a message to the system log.</p>
		<h4 id="priv">Cryptographic Data Files</h4>
		<p>File and link names are in the form <tt>ntpkey_<i>key</i>_<i>name</i>.<i>fstamp</i></tt>, where <tt><i>key</i></tt> is the key or parameter type, <tt><i>name</i></tt> is the host or group name and <tt><i>fstamp</i></tt> is the filestamp (NTP&nbsp;seconds) when the file was created). By convention, key fields in generated file names include both upper and lower case alphanumeric characters, while key fields in generated link names include only lower case characters. The filestamp is not used in generated link names.</p>
		<p>The key type is a string defining the cryptographic function. Key types include public/private keys <tt>host </tt>and <tt>sign</tt>, certificate <tt>cert</tt> and several challenge/response key types. By convention, files used for challenges have a <tt>par</tt> subtype, as in the IFF&nbsp;challenge <tt>IFFpar</tt>, while files for responses have a <tt>key</tt> subtype, as in the GQ response <tt>GQkey</tt>.</p>
		<p>All files begin with two nonencrypted lines. The first line contains the file name in the format <tt>ntpkey_<i>key</i>_<i>host</i>.<i>fstamp</i></tt>. The second line contains the datestamp in conventional Unix <tt>date</tt> format. Lines beginning with <tt>#</tt> are ignored.</p>
		<p>The remainder of the file contains cryptographic data encoded first using ASN.1 rules, then encrypted using the DES-CBC algorithm and given password and finally written in PEM-encoded printable ASCII text preceded and followed by MIME content identifier lines.</p>
		<p id="symkey">The format of the symmetric keys file is somewhat different than the other files in the interest of backward compatibility. Since DES-CBC is deprecated in NTPv4, the only key format of interest is MD5 alphanumeric strings. Following the header the keys are entered one per line in the format</p>
		<p><i><tt>keyno type key</tt></i></p>
		<p>where <i><tt>keyno</tt></i> is a positive integer in the range 1-65,535, <i><tt>type</tt></i> is the string <tt>MD5</tt> defining the key format and <i><tt>key</tt></i> is the key itself, which is a printable ASCII string 16 characters or less in length. Each character is chosen from the 93 printable characters in the range 0x21 through 0x7f excluding space and the '#' character.</p>
		<p>Note that the keys used by the <tt>ntpq</tt> and <tt>ntpdc</tt> programs are checked against passwords requested by the programs and entered by hand, so it is generally appropriate to specify these keys in human readable ASCII format.</p>
		<p>The <tt>ntp-keygen</tt> program generates a MD5 symmetric keys file <tt>ntpkey_MD5key_<i>hostname.filestamp</i></tt>. Since the file contains private shared keys, it should be visible only to root and distributed by secure means to other subnet hosts. The NTP daemon loads the file <tt>ntp.keys</tt>, so <tt>ntp-keygen</tt> installs a soft link from this name to the generated file. Subsequently, similar soft links must be installed by manual or automated means on the other subnet hosts. While this file is not used with the Autokey Version 2 protocol, it is needed to authenticate some remote configuration commands used by the <a href="ntpdc.html"><tt>ntpq</tt></a> and <a href="ntpq.html"><tt>ntpdc</tt></a> utilities.</p>
		<h4 id="bug">Bugs</h4>
		<p>It can take quite a while to generate some cryptographic values, from one to several minutes with modern architectures such as UltraSPARC and up to tens of minutes to an hour with older architectures such as SPARC IPC.</p>
		<hr>
		<script type="text/javascript" language="javascript" src="scripts/footer.txt"></script>
	</body>

</html>