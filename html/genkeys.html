<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>

    <head>
        <meta name="generator" content="HTML Tidy, see www.w3.org">
        <title>ntp-keygen - generate public and private keys</title>
        <link href="scripts/style.css" type="text/css" rel="stylesheet">
    </head>

    <body>
        <h3><tt>ntp-keygen</tt> - generate public and private keys</h3>
        <img src="pic/alice23.gif" alt="gif" align="left"><a href="http://www.eecis.udel.edu/%7emills/pictures.html">from <i>Alice's Adventures in Wonderland</i>, Lewis Carroll</a>
        <p>Alice holds the key.</p>
        <p>Last update: <csobj format="ShortTime" h="24" locale="00000409" region="0" t="DateTime" w="50">21:04</csobj> UTC <csobj format="LongDate" h="24" locale="00000409" region="0" t="DateTime" w="257">Monday, December 09, 2002</csobj></p>
        <br clear="left">
        <h4>Related Links</h4>
        <script type="text/javascript" language="javascript" src="scripts/links9.txt"></script>
        <h4>Table of Contents</h4>
        <ul>
            <li class="inline"><a href="#intro">Introduction</a>
            <li class="inline"><a href="#run">Running the program</a>
            <li class="inline"><a href="#trust">Trusted Hosts and Groups</a>
            <li class="inline"><a href="#idexp">Identity Schemes</a>
            <li class="inline"><a href="#exam">Example</a>
            <li class="inline"><a href="#cmd">Command Line Options</a>
            <li class="inline"><a href="#symkey">Symmetric Key File</a>
            <li class="inline"><a href="#priv">Private Key Files</a>
            <li class="inline"><a href="#ident">Identification Parameter Files</a>
            <li class="inline"><a href="#cert">Certificates</a>
            <li class="inline"><a href="#leap">Leapseconds Table</a>
            <li class="inline"><a href="#fmt">File Formats</a>
            <li class="inline"><a href="#bug">Bugs</a>
        </ul>
        <hr>
        <h4 id="#intro">Introduction</h4>
        <p>This program generates cryptographic data files used by the NTPv4 authentication and identification schemes. It generates MD5 key files used in symmetric key cryptography. In addition, if the OpenSSL software library has been installed, it generates key, certificate and parameter files used in public key cryptography. These files are used for cookie encryption, digital signature and challenge/response identification algorithms compatible with the Internet standard security infrastructure.</p>
        <p>All files are in PEM-encoded printable ASCII format, so they can be embedded as MIME attachments in mail to other sites and certificate authorities. Files containing private values can be password encrypted. File names begin with the prefix <tt>ntpkey_</tt> and end with the postfix <tt><i>_hostname.filestamp</i></tt>, where <tt><i>hostname</i></tt> is the owner name, usually the string returned by the Unix <tt>gethostname()</tt> routine, and <tt><i>filestamp</i></tt> is the NTP seconds when the file was generated, in decimal digits. This both guarantees uniqueness and simplifies maintenance procedures, since all files can be quickly removed by a <tt>rm ntpkey*</tt> command or all files generated at a specific time can be removed by a <tt>rm *<i>filestamp</i></tt> command. To further reduce the risk of misconfiguration, the first two lines of a file contain the file name and generation date and time as comments.</p>
        <p>All files are installed by default in the keys directory <tt>/usr/local/etc</tt>, which is normally in a shared filesystem in NFS-mounted networks. The actual location of the keys directory or each file can be overridden by configuration commands, but this is not recommended. Normally, the files for each host are generated by that host and used only by that host, although exceptions exist as noted later on this page.</p>
        <p>Normally, files containing private values, including the host key, sign key and identification parameters, are permitted root read/write-only; while others containing public values are permitted world readable. Alternatively, files containing private values can be encrypted with a chosen password and all files permitted world readable, which simplifies maintenance in shared file systems. Since uniqueness is insured by the hostname and file name extensions, the files for a NFS server and dependent clients can all be installed in the same shared directory.</p>
        <p>The recommended practice is to keep the file name extensions when installing a file and to install a soft link from the generic names specified elsewhere on this page to the generated files. This allows new file generations to be activated simply by changing the link. However, <tt>ntpd</tt> parses the link name when present to extract the filestamp and sends it along with the public key and host name when requested. This allows clients to verify that the file and generation times are always current. The <tt>ntp-keygen</tt> program uses the same timestamp extension for all files generated at one time, so each generation is distinct and can be readily recognized in monitoring data.</p>
        <p>As explained in the <a href="authopt.html">Authentication Options</a> page, all cryptographically sound key generation schemes must have means to randomize the entropy seed used to initialize the internal random number generator. The OpenSSL library uses a designated random seed file for this purpose. The file must be available when starting the NTP daemon and <tt>ntp-keygen</tt> program. If a site supports OpenSSL or its companion OpenSSH, it is very likely that means to do this are already available.</p>
        <h4 id="#run">Running the program</h4>
        <p>The safest way to run the <tt>ntp-keygen</tt> program is logged in directly as root. The recommended procedure is change to the keys directory, usually <tt>/ust/local/etc</tt>, then run the program. When run for the first time, or if all <tt>ntpkey</tt> files have been removed, the program generates a RSA host key file and matching RSA-MD5 certificate file, which is all that is necessary in many cases. The program also generates soft links from the generic names to the respective files. If run again, the program uses the same host key file, but generates a new certificate file and link.</p>
        <p>The host key is used to encrypt the cookie when required and so must be RSA type. By default, the host key is also the sign key used to encrypt signatures. When necessary, a different sign key can be specified and this can be either RSA or DSA type. By default, the message digest type is MD5, but any combination of sign key type and message digest type supported by the OpenSSL library can be specified.</p>
        <p>Running the program as other than root and using the Unix <tt>su</tt> command to assume root may not work properly, since by default the OpenSSL library looks for the random seed file <tt>.rnd</tt> in the user home directory. However, there should be only one <tt>.rnd</tt>, most conveniently in the root directory, so it is convenient to define the <tt>$RANDFILE</tt> environment variable used by the OpenSSL library as the path to <tt>/.rnd</tt>.</p>
        <p>Installing the keys as root might not work in NFS-mounted shared file systems, as NFS clients may not be able to write to the shared keys directory, even as root. In this case, NFS clients can specify the files in another directory such as <tt>/etc</tt> using the <tt>keysdir</tt> command. There is no need for one client to read the keys and certificates of other clients or servers, as these data are obtained automatically by the Autokey protocol.</p>
        <p>Ordinarily, cryptographic files are generated by the host that uses them, but it is possible for a trusted agent (TA) to generate these files for other hosts; however, in such cases the private values should always be password-encrypted. The password is supplied as the <tt>-p</tt> option to the <tt>ntp-keygen</tt> program and as the <tt>pw</tt> subcommand in the <tt>ntpd</tt> configuration file. The owner name and trusted name default to the name of the host generating the files, but can be changed by command line options. It is convenient to designate the owner name and trusted name as the subject and issuer fields, respectively, of the certificate. The owner name is also used for the host and sign key files, while the trusted name is used for the identity files.</p>
        <h4 id="#trust">Trusted Hosts and Groups</h4>
        <p>Each cryptographic configuration involves selection of a signature scheme and identification scheme, called a cryptotype, as explained in the <a href="authopt.html">Authentication Options</a> page. The default cryptotype uses RSA encryption, MD5 message digest and default (TC) identification. First, configure a NTP subnet including a number of low-stratum time servers from which all other subnet members derive synchronization directly or indirectly. These servers are considered trusted and will have trusted certificates. All others will automatically and dynamically build authoritative certificate trails to these servers.</p>
        <p>On each trusted server as root, change to the keys directory. To insure a fresh fileset, remove all <tt>ntpkey</tt> files. Then run <tt>ntp-keygen -T</tt> to generate keys and a trusted certificate. On all other hosts do the same, but leave off the <tt>-T</tt> flag to generate keys and nontrusted certificates. When complete, start the NTP daemons beginning at the lowest stratum and working up the tree. It may take some time for Autokey to instantiate the certificate trails throughout the subnet, but setting up the environment is completely automatic. The <tt>ntp-keygen</tt> program can be run to refresh the certificate without affecting ongoing operations; however, if the keys are refreshed, the NTP&nbsp;daemon should be restarted.</p>
        <p>NTP groups can be used to define cryptographic compartments, as described on the <a href="http://www.eecis.udel.edu/~mills/ident.html">Autokey Protocol</a> page. It is important that every host in the group be able to construct a certificate trail to one or more trusted hosts in the same group. Ordinarily, each group host runs the Autokey protocol to obtain the certificates for all hosts along the trail to one or more trusted hosts. This requires the configuration file in all hosts to be engineered so that, even under anticipated failure conditions, the NTP&nbsp;subnet will form such that every group host can find a trail to at least one trusted host. If the trail is broken so that no trusted certificate can be found, a host will loop forever (at low rate) until a trail becomes available.</p>
        <p>A host can be a member of more than one group if it has the necessary credentials. It might be the case, for example, that the servers in one corporation be members of the corporate group, as well as clients of a national standards group from which it imports time. In such cases a trusted host exports server credentials when operating as a server and imports client credentials of the group specific to each association. For instance, trusted server <i>alice</i> exports her server credentials to dependent clients, but imports <i>bob</i> client credentials for the associations where the certificate trail ends at trusted host <i>bob </i>in a different group<i>.</i></p>
        <p>After setting up the environment it is advisable to update certificates from time to time, if only to extend the validity interval. Simply run <tt>ntp-keygen</tt> with the same flags as before to generate new certificates using existing keys. The next time <tt>ntpd</tt> is started, it will load the new certificate and restart the protocol. Since the keys have not changed, other dependent hosts will continue as usual until signatures are refreshed and the protocol is restarted, which occurs about once per day.</p>
        <h4 id="#idexp">Identity Schemes</h4>
        <p>As mentioned on the Autonomous Authentication page, the default TC identity scheme is vulnerable to a middleman attack. However, there are more secure identity schemes available, including PC, IFF, GQ and MV described in the <a href="http://www.eecis.udel.edu/~mills/keygen.html">Identification Schemes</a> page. These schemes are based on a TA and a group of hosts deriving trust from the TA. The TA is not necessarily one of the group hosts, but often is. Group membership is defined by private and public keys generated by the TA and distributed by secure means to all group hosts.</p>
        <p>In some schemes there are separate keys for servers and clients. A server can also be a client of another server, but a client can never be a server for another client. In general, a trusted host or TA&nbsp;is always a server and never a client of the same group, so these hosts have only server keys. Note that the name of the group is the subject and issuer names in the trusted certificate; that is, the certificate is self-signed.</p>
        <p>The PC scheme is set up as follows. On TA <i>alice</i> run <tt>ntp-keygen -P -p <i>password</i></tt> to generate the host key file <tt>ntpkey_RSAkey_<i>alice.filestamp</i></tt> and private certificate file <tt>ntpkey_RSA-MD5_cert_<i>alice.filestamp</i></tt>. Do not generate keys and certificates on the other group hosts; however, be sure to specify <tt>pw <i>password</i></tt> in the <tt>crypto</tt> command in all NTP&nbsp;configuration files. Note that, as with all encrypted files, the <tt>ntp-keygen</tt> program prompts for the password if it reads an encrypted file and the <tt>-p</tt> option is not present.</p>
        <p>Copy the host key file and private certificate file to all group hosts. On each host <i>bob</i> install a soft link from the generic name <tt>ntpkey_host_<i>bob</i></tt> to the host key file and soft link <tt>ntpkey_cert_<i>bob</i></tt> to the private certificate file. Note the generic links are on <i>bob</i>, but point to files generated by <i>alice</i> as the trusted host. In this scheme it is not possible to refresh either the keys or certificates in any host without copying them to all other hosts in the group.</p>
        <p>The IFF scheme is set up as follows. On TA <i>alice</i> run the <tt>ntp-keygen</tt> program with the <tt>-I -p <i>password</i></tt> options to produce the server key file <tt>ntpkey_IFFpar_<i>alice.filestamp</i></tt> and client key file <tt>ntpkey_IFFkey_<i>alice.filestamp</i></tt>. The only difference between these files is the server has the private group key and the client does not; therefore, a client cannot masquerade as a rogue server. Proceed as in the TC scheme to generate keys and certificates for each group host. Then, copy the server key file to all group hosts that can operate as servers or clients of other servers and the client key file to group hosts that can operate only as clients. On all group servers and clients install a soft link from the generic <tt>ntpkey_iff_<i>alice</i></tt> to the client key file. On each server <i>bob</i> install a soft link from generic <tt>ntpkey_iff_<i>bob</i></tt> to the server key file. As the IFF scheme is independent of keys and certificates, these files can be refreshed as needed.</p>
        <p>The GQ scheme is set up as follows. On TA <i>alice</i> run the <tt>ntp-keygen</tt> program with the <tt>-G -p <i>password</i></tt> options to produce the server/client key file <tt>ntpkey_GQpar_<i>alice.filestamp</i></tt>. Proceed as in the TC scheme to generate keys and certificates for each group host. Then, copy the server/client key file to all group hosts. On all group servers and clients install a soft link from the generic <tt>ntpkey_gq_<i>alice</i></tt> to this file. On each server <i>bob</i> install a soft link from generic <tt>ntpkey_gq_<i>bob</i></tt> to this file. As the GQ scheme updates the GQ parameters file and certificate at the same time, keys and certificates can be regenerated as needed.</p>
        <p>The MV scheme is set up as follows. On TA <i>Alice</i> run the <tt>ntp-keygen</tt> program with the <tt>-V&nbsp;<i>n</i> -p <i>password</i></tt> options, where <i>n</i> is the number of revokable keys (typically 5) to produce the server key file <tt>ntpkeys_MVpar_<i>alice.filestamp </i></tt>and client key files <tt>ntpkeys_MVkey<i>d</i>_<i>alice.filestamp</i></tt> where <i><tt>d</tt></i> is the key number (0 &lt; <i><tt>d</tt></i> &lt; <i>n</i>). Then, distribute the client key files throughout the group. It doesn't matter which client key file goes to which group host; they all work the same. But, keep in mind it is possible for a TA-server conspiracy to selectively deactivate a key in case of compromise. On each client <i>dave</i> install a soft link from generic <tt>ntpkey_mv_<i>alice </i></tt>to the client key file. On each server <i>bob</i> install a soft link from generic <tt>ntpkey_mv_<i>bob</i></tt> to the server key file. Note that the MV scheme is independent of host key and certificates, these files can be refreshed as needed.</p>
        <p>If it is necessary to use a different sign key or different digest/signature scheme than the default, run <tt>ntp-keygen</tt> with the <tt>-S</tt> option and either <tt>RSA</tt> or <tt>DSA</tt> argument as needed. The most often need to do this is when a DSA-signed certificate is used. If <tt>ntp-keygen</tt> is run again without the option, it will generate a new certificate using the existing sign key. If it is necessary to use a different certificate scheme than the default, run <tt>ntp-keygen</tt> with the <tt>-c</tt> option and selected scheme as needed. If <tt>ntp-keygen</tt> is run again without the option, it will generate a new certificate using the same scheme and existing sign key.</p>
        <h4 id="#exam">Example</h4>
        <p>First, generate the host key, trusted host certificate and IFF identity file for trusted host <i>whimsy</i>. The <tt>ntp-keygen</tt> program on <i>whimsy</i> produces the following typescript.</p>
        <pre>whimsy:/usr/local/etc# ntp-keygen -T -I -pqqsv
Using OpenSSL version 90607f
Random seed file /.rnd 1024 bytes
Generating IFF parameters (512 bits)...
IFF 0 159 188   1 49 118        2 1 2           3 1 2
Generating IFF keys (512 bits)...
Confirm g^(q - b) g^b = 1 mod p: yes
Confirm g^k = g^(k + b r) g^(q - b) r: yes
Generating new iff file and link
ntpkey_iff_whimsy.udel.edu-&gt;ntpkey_IFFpar_whimsy.udel.edu.3248306666
Generating RSA keys (512 bits)...
RSA 0 16 207    1 11 142                        3 1 4
Generating new host file and link
ntpkey_host_whimsy.udel.edu-&gt;ntpkey_RSAkey_whimsy.udel.edu.3248306666
Using host key as sign key
Generating certificate RSA-MD5
X509v3 Basic Constraints: critical,CA:TRUE
X509v3 Key Usage: digitalSignature,keyCertSign
X509v3 Extended Key Usage: trustRoot
Generating new cert file and link
ntpkey_cert_whimsy.udel.edu-&gt;ntpkey_RSA-MD5cert_whimsy.udel.edu.3248306666
</pre>
        <p>The following files and links should be on <i>whimsy</i>:</p>
        <pre>ntpkey_IFFkey_whimsy.udel.edu.3248306666
ntpkey_IFFpar_whimsy.udel.edu.3248306666
MD5cert_whimsy.udel.edu.3248306666
ntpkey_RSAkey_whimsy.udel.edu.3248306666
ntpkey_cert_whimsy.udel.edu-&gt;ntpkey_RSA-MD5cert_whimsy.udel.edu.3248306666
ntpkey_host_whimsy.udel.edu-&gt;ntpkey_RSAkey_whimsy.udel.edu.3248306666
ntpkey_iff_whimsy.udel.edu-&gt;ntpkey_IFFpar_whimsy.udel.edu.3248306666
</pre>
        <p>Next, generate the host key and nontrusted host certificate for host <i>mort</i>. The <tt>ntp-keygen</tt> program on <i>mort</i> produces the following typescript.</p>
        <pre>mort:/usr/local/etc# ntp-keygen 
Using OpenSSL version 90607f
Random seed file /.rnd 1024 bytes
Generating RSA keys (512 bits)...
RSA                                             3 1 2
Generating new host file and link
ntpkey_host_mort.udel.edu-&gt;ntpkey_RSAkey_mort.udel.edu.3248306679
Using host key as sign key
Generating certificate RSA-MD5
X509v3 Basic Constraints: critical,CA:TRUE
X509v3 Key Usage: digitalSignature,keyCertSign
Generating new cert file and link
ntpkey_cert_mort.udel.edu-&gt;ntpkey_RSA-MD5cert_mort.udel.edu.3248306679
</pre>
        <p>On <i>whimsy</i>, copy the file <tt>ntpkey_IFFpar_whimsy.udel.edu.3248306666</tt> to <i>mort</i>.</p>
        <pre>whimsy:/usr/local/etc# scp ntpkey_IFFpar_whimsy.udel.edu.3248306666 mort:/usr/local/etc/ntpkey_IFFpar_whimsy.udel.edu.3248306666
</pre>
        <p>On <i>mort</i>, install the links</p>
        <pre>mort:/usr/local/etc# ln -s ntpkey_IFFpar_whimsy.udel.edu.3248306666 ntpkey_iff_whimsy.udel.edu
mort:/usr/local/etc# ln -s ntpkey_IFFpar_whimsy.udel.edu.3248306666 ntpkey_iff_mort.udel.edu
</pre>
        <p>Note the same file is linked from both hosts <i>whimsy</i> and <i>mort</i> if both are to be servers as well as clients. The following files and links should be on <i>mort</i>:</p>
        <pre>ntpkey_IFFpar_whimsy.udel.edu.3248306666
MD5cert_mort.udel.edu.3248306679
ntpkey_RSAkey_mort.udel.edu.3248306679
ntpkey_cert_mort.udel.edu-&gt;ntpkey_RSA-MD5cert_mort.udel.edu.3248306679
ntpkey_host_mort.udel.edu-&gt;ntpkey_RSAkey_mort.udel.edu.3248306679
ntpkey_iff_whimsy.udel.edu-&gt;ntpkey_IFFpar_whimsy.udel.edu.3248306666  ntpkey_iff_mort.udel.edu-&gt;ntpkey_IFFpar_whimsy.udel.edu.3248306666
</pre>
        <p>Following is edited output from the <tt>ntpq</tt> program on <i>whimsy</i> with the <tt>rv</tt> command. Note the self-sgned certificate subject and issuer names are <i>whimsy</i> and the <tt>0x2</tt> confirms the certificate is trusted.</p>
        <pre>hostname=&quot;whimsy.udel.edu&quot;, signature=&quot;md5WithRSAEncryption&quot;,
flags=0x80021, hostkey=3248306666, refresh=3248306823,
cert=&quot;whimsy.udel.edu whimsy.udel.edu 0x2 3248306666&quot;
</pre>
        <p>Following is edited output from the <tt>ntpq</tt> program on <i>mort</i> with the <tt>rv</tt> command. Note the self-sgned certificate subject and issuer names are <i>whimsy</i> and the <tt>0x2</tt> confirms the certificate is trusted. Note the Autokey protocol has fetched the trusted certificate for <i>whimsy</i>, confirmed <i>whimsy</i> identity with the IFF scheme and has its certificate signed by <i>whimsy</i>. The <tt>0x3</tt> confirms the certificates have all been validated as well.</p>
        <pre>hostname=&quot;mort.udel.edu&quot;, signature=&quot;md5WithRSAEncryption&quot;,
flags=0x80001, hostkey=3248306679, refresh=3248306943,
cert=&quot;mort.udel.edu whimsy.udel.edu 0x3 3248306679&quot;,
cert=&quot;whimsy.udel.edu whimsy.udel.edu 0x3 3248306666&quot;,
cert=&quot;mort.udel.edu mort.udel.edu 0x3 3248306679&quot;
</pre>
        <p>Following is edited output from the <tt>ntpq</tt> program on <i>mort</i> with the <tt>rv <i>assoc</i></tt> command. This reveals the association host name, signature scheme, flags (showing the IFF scheme) and trusted host name.</p>
        <pre>hostname=&quot;whimsy.udel.edu&quot;, signature=&quot;md5WithRSAEncryption&quot;,
flags=0x83f21, identity=&quot;whimsy.udel.edu&quot;
</pre>
        <h4 id="#cmd">Command Line Options</h4>
        <dl>
            <dt><tt>-c [ RSA-MD2 | RSA-MD5 | RSA-SHA | RSA-SHA1 | RSA-MDC2 | RSA-RIPEMD160 | DSA-SHA | DSA-SHA1 ]</tt>
            <dd>Select certificate message digest/signature encryption scheme. Note that RSA schemes must be used with a RSA sign key and DSA schemes must be used with a DSA sign key. The default without this option is <tt>RSA-MD5</tt>.
            <dt><tt>-d</tt>
            <dd>Enable debugging. This option displays the cryptographic data produced in eye-friendly billboards.
            <dt><tt>-e</tt>
            <dd>Insert arbitrary X509v3 extension field. Not for amateurs. Usually produces a coredump.
            <dt><tt>-G</tt>
            <dd>Generate parameters and keys for the GQ identification scheme, obsoleting any that may exist.
            <dt><tt>-g</tt>
            <dd>Generate keys for the GQ identification scheme using the existing GQ parameters. If the GQ parameters do not yet exist, create them first.
            <dt><tt>-H</tt>
            <dd>Generate new host keys, obsoleting any that may exist.
            <dt><tt>-I</tt>
            <dd>Generate parameters for the IFF identification scheme, obsoleting any that may exist.
            <dt><tt>-i <i>name</i></tt>
            <dd>Set the trusted name to <i>name</i>. This is used as the subject field in certificates and the file name in host and sign keys.
            <dt><tt>-M</tt>
            <dd>Generate MD5 keys, obsoleting any that may exist.
            <dt><tt>-P</tt>
            <dd>Generate a private certificate. By default, the program generates public certificates.
            <dt><tt>-p <i>password</i><tt></tt></tt>
            <dd>Encrypt generated files containing private data with the designated <tt><i>password</i></tt> and the DES-CBC algorithm.
            <dt><tt>-S [ RSA | DSA ]</tt>
            <dd>Generate a new sign key of the designated type, obsoleting any that may exist. By default, the program uses the host key as the sign key.
            <dt><tt>-s <i>name</i></tt>
            <dd>Set the trusted name to <i>name</i>. This is used for the issuer field in certificates and the file name for identity files.
            <dt><tt>-T</tt>
            <dd>Generate a trusted certificate. By default, the program generates a non-trusted certificate.
            <dt><tt>-V <i>nkeys</i></tt>
            <dd>Generate parameters and keys for the Mu-Varadharajan (MV) identification scheme.
        </dl>
        <h4 id="#symkey">Symmetric Key File</h4>
        <p>The <tt>ntp-keygen</tt> program generates a MD5 symmetric keys file <tt>ntpkey_MD5key_<i>hostname.filestamp</i></tt>. Since the file contains private shared keys, it should be visible only to root and distributed by secure means to other subnet hosts. The NTP daemon loads the file <tt>ntp.keys</tt>, so <tt>ntp-keygen</tt> installs a soft link from this name to the generated file. Subsequently, similar soft links must be installed by manual or automated means on the other subnet hosts. While this file is not used with the Autokey Version 2 protocol, it is needed to authenticate some remote configuration commands used by the <a href="ntpdc.html"><tt>ntpq</tt></a> and <a href="ntpq.html"><tt>ntpdc</tt></a> utilities.</p>
        <p>The symmetric key file contains 16 MD5 keys. Each key consists of 16 characters randomized over the ASCII 93-character printing subset. The file is read by the daemon at the location specified by the <tt>keys</tt> configuration file command. Additional keys consisting of easily remembered passwords should be added by hand for use with the <tt>ntpq</tt> and <tt>ntpdc</tt> programs. While the key identifiers for MD5 keys must be in the range 1-65,535, inclusive, the <tt>ntp-keygen</tt> program uses only the identifiers from 1 to 16. The key identifier for each association is specified as the <tt>key</tt> subcommand with the <tt>server</tt> or <tt>peer</tt> configuration command.</p>
        <h4 id="#priv">Private Key Files</h4>
        <p>The Autokey protocol requires every host to have a private/public host key pair and an optional private/public sign key pair. The <tt>ntp-keygen</tt> program generates a private key file <tt>ntpkey_<i>keyname</i>key_<i>hostname.filestamp</i></tt>, where <i><tt>keyname</tt></i> is the name of the public key algorithm type, either <tt>RSA</tt> or <tt>DSA</tt>. Since the host key is used to encrypt some data, it must be RSA type; the sign key file can be a RSA or DSA type. These files contain private values, so should be encrypted or visible only to root. The NTP daemon loads the host key file <tt>ntpkey_host_<i>hostname</i></tt> and the sign key file <tt>ntpkey_sign_<i>hostname</i></tt>, so <tt>ntp-keygen</tt> installs soft links to direct these names to the generated files.</p>
        <h4 id="#ident">Certificates</h4>
        <p>The Internet security infrastructure requires every host to have a digitally signed public certificate. Security procedures require the public key and host credentials, such as host name, responsible person, mail address, etc., to be provided in the form of a X.509 certificate request to a trusted certificate authority or CA. The CA attaches a digital signature to the request and returns the certificate with signature to the requesting party. The integrity of these procedures depend on the certificate trail that ultimately must end on a self-signed certificate provided by a trusted CA. The OpenSSL software library provides routines that can automate this process.</p>
        <p>Normally, the <tt>ntp-keygen</tt> program generates certificates which contain only public values, so they can be transmitted and stored without cryptographic protection. With the <tt>-P</tt> option the program generates a certificate including a &quot;X509v3 &quot;Extended Key Usage&quot; extension field with value <tt>private</tt> The intent when this field is present is never to disclose the certificate outside the host on which it is installed. Certificates generated without this option do not contain this field and are by default public.</p>
        <p>The Autokey TC identification scheme automates the certificate trail construction and verification process with each server at stratum <i>n</i> operating as a CA for clients at stratum <i>n</i> + 1. The <tt>ntp-keygen</tt> program generates a self-signed X.509v3 public certificate <tt>ntpkey_<i>digestname</i>cert_<i>hostname.filestamp</i></tt>, where <i><tt>digestname</tt></i> is the name of the digest/signature scheme. The NTP daemon loads the certificate <tt>ntpkey_cert_<i>hostname</i></tt>, so <tt>ntp-keygen</tt> installs soft links to direct this name to the generated file. The <tt>ntp-keygen</tt> program with the <tt>-T</tt> flag generates a trusted certificate including a &quot;X509v3 Extended Key Usage&quot; extension field with value <tt>trustRoot</tt>. Certificates generated without this option do not contain this field and are by default non-trusted.</p>
        <p>Public certificates contain only public values and can be freely transmitted and stored anywhere without further cryptographic protection, although this is rarely necessary. The Autokey protocol retrieves the server certificate and requests the server sign and return the client certificate. Where security considerations require, certificates can be transmitted to an outside trusted certificate authority (CA) and returned as a signed public certificate for use in the Autokey protocol.</p>
        <p>The Autokey protocol supports all digest/signature schemes available in the OpenSSL library, including those using the MD2, MD5, SHA, SHA1, MDC2 and RIPE160 message digest algorithms. However, the scheme specified in the certificate must be compatible with the sign key. Certificates using any digest algorithm are compatible with RSA sign keys; however, only SHA and SHA1 certificates are compatible with DSA sign keys.</p>
        <h4 id="#leap">Leapseconds Table</h4>
        <p>The NIST provides a file documenting the epoch for all historic occasions of leap second insertion since 1972. The leapsecond table shows each epoch of insertion along with the offset of International Atomic Time (TAI) with respect to Coordinated Universal Time (UTC), as disseminated by NTP. The table can be obtained directly from NIST national time servers using <tt>ftp</tt> as the ASCII file <tt>pub/leap-seconds</tt>.</p>
        <p>While not strictly a security function, the Autokey protocol provides means to securely retrieve the leapsecond table from a server or peer. Servers load the leapsecond table directly from the file specified in the <tt>crypto</tt> command, with default <tt>ntpkey_leap</tt>, while clients can obtain the table indirectly from the servers using the Autokey protocol. Once loaded, the table can be provided on request to other clients and servers.</p>
        <h4 id="#fmt">File Formats</h4>
        <p>The file formats begin with two lines. The first contains the file name, including the generated hostname and filestamp. The second contains the datestamp in conventional Unix <tt>date</tt> format. Lines beginning with <tt>#</tt> are considered comments and ignored by the daemon. In the <tt>ntp.keys</tt> file, the next 16 lines contain the MD5 keys. If necessary, this file can be further customized using an ordinary text editor. The format is described below. For all other files the cryptographic values are encoded first using ASN.1 encoding rules and then in PEM-encoded printable ASCII format preceded and followed by MIME content identifier lines.</p>
        <p>Private/public key files and certificates are compatible with other OpenSSL applications and very likely other libraries as well. Certificates or certificate requests derived from them should be compatible with extant industry practice, although some users might find the interpretation of X509v3 extension fields somewhat liberal. However, the identification parameter files, although encoded as the other files, are probably not compatible with anything other than Autokey.</p>
        <p>The format of the symmetric keys file is somewhat different than the other files in the interest of backward compatibility. Since DES-CBC is deprecated in NTPv4, the only key format of interest is MD5 alphanumeric strings. Keys are entered one per line in the format</p>
        <p><i><tt>keyno type key</tt></i></p>
        <p>where <i><tt>keyno</tt></i> is a positive integer in the range 1-65,535, <i><tt>type</tt></i> is the string <tt>MD5</tt> defining the key format and <i><tt>key</tt></i> is the key itself, which is a printable ASCII string 16 characters or less in length. Each character is chosen from the 93 printable characters in the range 0x21 through 0x7f excluding space and the '#' character.</p>
        <p>Note that the keys used by the <tt>ntpq</tt> and <tt>ntpdc</tt> programs are checked against passwords requested by the programs and entered by hand, so it is generally appropriate to specify these keys in human readable ASCII format.</p>
        <h4 id="#bug">Bugs</h4>
        <p>It can take quite a while to generate some cryptographic values, from one to several minutes with modern architectures such as UltraSPARC and up to tens of minutes to an hour with older architectures such as SPARC IPC.</p>
        <hr>
        <script type="text/javascript" language="javascript" src="scripts/footer.txt"></script>
    </body>

</html>