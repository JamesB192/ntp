<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">

<html>

	<head>
		<meta http-equiv="content-type" content="text/html;charset=iso-8859-1">
		<meta name="generator" content="HTML Tidy, see www.w3.org">
		<title>Authentication Options</title>
		<link href="scripts/style.css" type="text/css" rel="stylesheet">
	</head>

	<body>
		<h3>Authentication Options</h3>
		<img src="pic/alice44.gif" alt="gif" align="left"><a href="http://www.eecis.udel.edu/%7emills/pictures.html">from <i>Alice's Adventures in Wonderland</i>, Lewis Carroll</a>
		<p>Our resident cryptographer; now you see him, now you don't.</p>
		<p>Last update: <csobj format="ShortTime" h="25" locale="00000409" region="0" t="DateTime" w="61">02:46</csobj> UTC <csobj format="LongDate" h="25" locale="00000409" region="0" t="DateTime" w="301">Monday, September 03, 2007</csobj></p>
		<br clear="left">
		<h4>Related Links</h4>
		<script type="text/javascript" language="javascript" src="scripts/links9.txt"></script>
		<h4>Table of Contents</h4>
		<ul>
			<li class="inline"><a href="#auth">Authentication Support</a>
			<li class="inline"><a href="#symm">Symmetric Key Cryptography</a>
			<li class="inline"><a href="#pub">Public Key Cryptography</a>
			<li class="inline"><a href="#group">NTP Secure Groups</a>
			<li class="inline"><a href="#name">Naming Conventions</a>
			<li class="inline"><a href="#cfg">Configuration</a>
			<li class="inline"><a href="#inter">Operation</a>
			<li class="inline"><a href="#cmd">Authentication Commands</a>
			<li class="inline"><a href="#err">Error Codes</a>
			<li class="inline"><a href="#file">Files</a>
		</ul>
		<hr>
		<h4 id="auth">Authentication Support</h4>
		<p>Authentication support allows the NTP client to verify that the server is in fact known and trusted and not an intruder intending accidentally or on purpose to masquerade as a legitimate server. The NTPv3 specification RFC-1305 defines a scheme which provides cryptographic authentication of received NTP packets. Originally, this was done using the Data Encryption Standard (DES) algorithm operating in Cipher Block Chaining (CBC) mode, commonly called DES-CBC. Subsequently, this was replaced by the RSA Message Digest 5 (MD5) algorithm using a private key, commonly called keyed-MD5. Either algorithm computes a message digest, or one-way hash, which can be used to verify the server has the correct private key and key identifier.</p>
		<p>NTPv4 retains the NTPv3 scheme, properly described as symmetric key cryptography and, in addition, provides a new Autokey scheme based on public key cryptography. Public key cryptography is generally considered more secure than symmetric key cryptography, since the security is based on private values which are generated by each participant and never revealed. With the exception of the group parameters described later, all key distribution and management functions involve only public values, which considerably simplifies key distribution and storage. Public key management is based on X.509 certificates, which can be provided by commercial services or produced by utility programs in the OpenSSL software library or the NTPv4 distribution.</p>
		<p>While the algorithms for symmetric key cryptography are included in the NTPv4 distribution, public key cryptography requires the OpenSSL software library to be installed before building the NTP distribution. This library is available from <a href="http://www.openssl.org">http://www.openssl.org</a> and can be installed using the procedures outlined in the <a href="build/build.html">Building and Installing the Distribution</a> page. Once installed, the configure and build process automatically detects the library and links the library routines required.</p>
		<p>Authentication is configured separately for each association using the <tt>key</tt> or <tt>autokey</tt> subcommand on the <tt>peer</tt>, <tt>server</tt>, <tt>broadcast</tt> and <tt>manycastclient</tt> configuration commands as described in the <a href="confopt.html">Configuration Options</a> page. The authentication options described below specify the locations of the key files, if other than default, which symmetric keys are trusted and other details needed by the optional Autokey protocol. The <a href="keygen.html">ntp-keygen</a> program is used to generate the  various key files, certificate files and identity parameters files described below.</p>
		<p>Authentication is always enabled, although ineffective if not configured as described below. If an NTP packet includes a message authentication code (MAC), consisting of a key ID;and message digest, it is accepted only if the key ID&nbsp;matches a trusted key and and the message digest is verified with this key. Furthermore, the Autokey scheme requires a preliminary protocol exchange to obtain the server certificate, verify its credentials and initialize the protocol</p>
		<p>The <tt>auth</tt> flag controls whether new associations or remote configuration commands require cryptographic authentication. This flag can be set or reset by the <tt>enable</tt> and <tt>disable</tt> commands and also by remote configuration commands sent by a <tt>ntpdc</tt> program running on another machine. If this flag is enabled, which is the default, new broadcast/manycast client and symmetric passive associations and remote configuration commands must be cryptographically authenticated using either symmetric key or public key cryptography. If this flag is disabled, these operations are effective even if not cryptographic authenticated. It should be understood that operating with the <tt>auth</tt> flag disabled invites a significant vulnerability where a rogue hacker can masquerade as a legitimate server and seriously disrupt system timekeeping. It is important to note that this flag has no purpose other than to allow or disallow a new association in response to new broadcast and symmetric active messages and remote configuration commands and, in particular, the flag has no effect on the authentication process itself.</p>
		<p>The security model and protocol schemes for both symmetric key and public key cryptography are summarized below; further details are in the briefings, papers and reports at the NTP project page linked from <a href="http://www.ntp.org">www.ntp.org</a>.</p>
		<h4 id="symm">Symmetric Key Cryptography</h4>The original RFC-1305 specification allows any one of possibly 65,534 keys (excluding zero), each distinguished by a 32-bit key identifier, to authenticate an association. The servers and clients involved must agree on the key and key identifier to authenticate NTP packets. Keys and related information are specified in a key file, usually called <tt>ntp.keys</tt>, which must be distributed and stored using secure means beyond the scope of the NTP protocol itself. Besides the keys used for ordinary NTP associations, additional keys can be used as passwords for the <tt><a href="ntpq.html">ntpq</a></tt> and <tt><a href="ntpdc.html">ntpdc</a></tt> utility programs. Ordinarily, the <tt>ntp.keys</tt> file is generated by the <tt><a href="keygen.html">ntp-keygen</a></tt> program.
		<p>When <tt>ntpd</tt> is first started, it reads the key file specified in the <tt>keys</tt> configuration command and installs the keys in the key cache. However, individual keys must be activated with the <tt>trustedkey</tt> command before use. This allows, for instance, the installation of possibly several batches of keys and then activating or deactivating each batch remotely using <tt>ntpdc</tt>. This also provides a revocation capability that can be used if a key becomes compromised. The <tt>requestkey</tt> command selects the key used as the password for the <tt>ntpdc</tt> utility, while the <tt>controlkey</tt> command selects the key used as the password for the <tt>ntpq</tt> utility.</p>
		<h4 id="pub">Public Key Cryptography</h4>
		<p>NTPv4 supports the Autokey security protocol, which is based on public key cryptography. The Autokey Version 2 protocol described on the <a href="http://www.eecis.udel.edu/%7emills/proto.html">Autokey Protocol</a> page verifies packet integrity using MD5 message digests and verifies the source using digital signatures and any of several digest/signature schemes. Optional identity schemes described on the <a href="http://www.eecis.udel.edu/%7emills/ident.html">Identity Schemes</a> page are based on cryptographic challenge/response exchanges. Using these schemes provides strong security against replay with or without modification, spoofing, masquerade and most forms of clogging attacks. These schemes are described along with an executive summary, current status, briefing slides and reading list on the <a href="http://www.eecis.udel.edu/%7emills/autokey.html">Autonomous Authentication</a> page.</p>
		<p>The specific cryptographic environment used by Autokey servers and clients is determined by a set of files and soft links generated by the <a href="keygen.html"><tt>ntp-keygen</tt></a> program. These define the required host key, required host certificate and optional sign key and identity parameters. The certificate defines the Autokey host name and the selected cryptographic algorithms.</p>
		<h4 id="group">NTP Secure Groups</h4>
		<p>NTP secure groups are used to define cryptographic compartments and security hierarchies. All hosts belonging to a named secure group share a secret group key which can be encrypted with individual passwords. Each group includes one or more trusted hosts operating at the root, or lowest stratum in the group. The other hosts in the group are configured to provide an unbroken path, called a certificate trail, from each host, possibly via intermediate hosts, to one or more trusted hosts. When the protocol first starts, each host recursively retrieves the certificates along the trail in order to verify the host identity and avoid masquerade and middleman attacks. The trail concludes at a trusted host, the name of which defines the identity parameters used to confirm group membership.</p>
		<p>Secure groups can be configured as hierarchies where the trusted hosts of one group can be clients of one or more other groups operating at a lower stratum. In one scenario, groups RED&nbsp;and GREEN&nbsp;can be cryptographically distinct, but both be clients of group BLUE&nbsp;operating at a lower stratum. In another scenario, group CYAN&nbsp;can be a client of multiple groups YELLOW&nbsp;and MAGENTA, both operating at a lower stratum. There are many other scenarios, but all must be configured to include only acyclic certificate trails.</p>
		<h4 id="name">Naming Conventions</h4>
		<p>It is important to note that Autokey does not use DNS&nbsp;to resolve names or addresses, since DNS can't be completely trusted until the name servers have synchronized clocks. The Autokey names for hosts and groups are used only to verify group membership and create group hierarchies.</p>
		<p>By convention the Autokey name of a group host other than the trusted hosts is the name returned by the Unix <tt>gethostname()</tt> system call or equivalent in other systems. Also by convention the host name for all trusted hosts is the same name, called the group name. However, it is possible to use other names as long as the certificate trails remain acyclic. The group name is also the name of the identity parameters resident in every group host.</p>
		<p>Autokey authenticates individual packets using cookies bound to the IP source and destination addresses. The cookies must have the same addresses at both the server and client. For this reason operation with network address translation schemes is not possible. This reflects the intended robust security model where government and corporate NTP&nbsp;servers are operated outside firewall perimeters.</p>
		<h4 id="cfg">Configuration</h4>
		<p>Autokey has an intimidating number of options, most of which are not necessary in typical scenarios. The simplest scenario consists of a secure group with one or more trusted hosts at the same low stratum and with dependent clients at higher strata, all sharing the same group identity parameters.</p>
		<p>On behalf of the group, a trusted host generates a host key, trusted certificate and identity parameters, all encrypted with a private password. Other hosts generate a host key encrypted with a private password and public nontrusted certificate. In the intended model, a host sends a mail message to a trusted host and requests the group identity parameters encrypted with a specified password. Note that, at least in the IFF&nbsp;scheme, the client parameters is a subset of the identity parameters, so hosts other than trusted hosts cannot masquerated as trusted.</p>
		<p>The remaining group hosts are configured to provide an acyclic certificate trail ending at a trusted host. There is some art to this process, which may depend on anticipated failure scenarios where the trail might become discontinuous. In general, the trail should follow the expected stratum trail and provide redundancy.</p>
		<h4>Operation</h4>
		<p>A specific combination of authentication scheme (none, symmetric key, public key) and identity scheme is called a cryptotype, although not all combinations are compatible. There may be management configurations where the clients, servers and peers may not all support the same cryptotypes. A secure NTPv4 subnet can be configured in many ways while keeping in mind the principles explained above and in this section. Note however that some cryptotype combinations may successfully interoperate with each other, but may not represent good security practice.</p>
		<p>The cryptotype of an association is determined at the time of mobilization, either at configuration time or some time later when an NTP packet of appropriate cryptotype arrives. When mobilized by a <tt>server</tt> or <tt>peer</tt> configuration command and no <tt>key</tt> or <tt>autokey</tt> subcommands are present, the association is not authenticated. If the <tt>key</tt> subcommand is present, the association is authenticated using the symmetric key ID specified. If the <tt>autokey</tt> subcommand is present, the association is authenticated using Autokey.</p>
		<p>With Autokey, the cryptotype of the association is determined by the set of files generated by the <a href="keygen.html"><tt>ntp-keygen</tt></a> utility program. All configurations include a public/private host key and matching certificate. Absent identity parameters, this is a Trusted Certificate (TC)&nbsp;scheme. There are three identity schemse, IFF, GQ&nbsp;and MV destcribed on the <a href="http://www.eecis.udel.edu/%7emills/ident.html">Identity Schemes</a> page. Each is characterized by a set of private parameters that are distributed to each group host by secure means.</p>
		<p>A group can operate where the cryptotype can be different for each client. One client can elect to use no authentication at all, another with the TC&nbsp;scheme and others with IFF, GQ and/or MV. However, a host cannot prove identity to a downstream client unless it has the corresponding identity parameters.</p>
		<p>Examples</p>
		<p>The figure shows what might be a typical scenario involving three secure groups called Alice, Helen and Carol. Alice has trusted hosts A and B and nontrusted hosts C and D. Helen has trusted host R and nontrusted host S. Carol has trusted host X and nontrusted hosts Y and Z. Trusted host X in Carol is a client of nontrusted host C in Alice and nontrusted host S in Helen. Assume the IFF&nbsp;identity scheme is used in Alice, the GQ identity scheme in Helen and the TC&nbsp;scheme in Carol. For clarity, assume the passwords for all hosts in a group is the group name.</p>
		<p><img src="../pic/sgroup.gif" alt="gif"></p>
		<p>Run the ntp-keygen program on the Alice hosts:</p>
		<p>A: ntp-keygen -q alice -s alice -T&nbsp;-I<br>
			B: ntp-keygen -q alice -s alice -T<br>
			C and D: ntp-keygen -q alice -i alice</p>
		<p>Copy the ntp_IFFpar_alice.fstamp file and ntp_iff_alice link from A to all group hosts B, C and D. Since the paswords are the same, it is not necessary to use the -p option.</p>
		<p>In the NTP&nbsp;configuration files for Alice hosts:</p>
		<p>A and B:&nbsp;crypto pw alice host alice<br>
			C and D: crypto pw alice ident alice</p>
		<p>Run the ntp-keygen program on Helen hosts:</p>
		<p>R: ntp-keygen -q helen -s helen -T&nbsp;-G<br>
			S: ntp-keygen -q helen -i helen</p>
		<p>Copy the C</p>
		<p>In the NTP&nbsp;configuration files for Alice hosts:</p>
		<p>R: server (radio clock)<br>
			crypto pw helen host helen<br>
			S: server R<br>
			crypto pw helen ident helen</p>
		<p>Run the ntp-keygen on Carol hosts:</p>
		<p>X:&nbsp;ntp-keygen pw carol host carol<br>
			Y, Z:&nbsp;ntp-keygen -q carol -i carol</p>
		<p>Since X is a client of both Alice and Helen, copy the ntp_IFFpar_alice.fstamp file and ntp_iff_alice link from A to X and the ntp_IFFpar_alice.fstamp file and ntp_iff_alice link from R to X. When X follows the certificate trail to either A or B, it will find the Alice self-signed certificate for Alice load the GQ identity scheme for Alice. A similar operation will occur for Helen.</p>
		<p>Authentication Commands</p>
		<dl>
			<dt><tt>autokey [<i>logsec</i>]</tt>
			<dd>Specifies the interval between regenerations of the session key list used with the Autokey protocol. Note that the size of the key list for each association depends on this interval and the current poll interval. The default value is 12 (4096 s or about 1.1 hours). For poll intervals above the specified interval, a session key list with a single entry will be regenerated for every message sent.
			<dt><tt>controlkey <i>key</i></tt>
			<dd>Specifies the key identifier to use with the <a href="ntpq.html"><tt>ntpq</tt></a> utility, which uses the standard protocol defined in RFC-1305. The <tt><i>key</i></tt> argument is the key identifier for a trusted key, where the value can be in the range 1 to 65,534, inclusive.
			<dt><tt>crypto [cert <i>file</i>]  [randfile <i>file</i>] [host <i>file</i>] [sign <i>file</i>] [ident <i>groupname</i>] [pw <i>password</i>]</tt>
			<dd>This command requires the OpenSSL library. It activates public key cryptography and loads the required public/private encryption and sign kyes and public certificat. If one or more files are left unspecified, the default names are used as described below. Unless the complete path and name of the file are specified, the location of a file is relative to the keys directory specified in the <tt>keysdir</tt> command or default <tt>/usr/local/etc</tt>. Following are the subcommands:
				<dl>
					<dt><tt>cert <i>file</i></tt>
					<dd>Specifies the location of the required host public certificate file. This overrides the link <tt>ntpkey_cert_<i>hostname</i></tt> in the keys directory.
					
					
					<dt><tt>host <i>file</i></tt>
					<dd>Specifies the location of the required host key file. This overrides the link <tt>ntpkey_host_<i>hostname</i></tt> in the keys directory.
					
					<dt><tt>pw <i>password</i></tt>
					<dd>Specifies the password to decrypt files containing private keys and identity parameters.<dt><tt>randfile <i>file</i></tt>
					<dd>Specifies the location of the random seed file used by the OpenSSL library. The defaults are described on the <a href="keygen.html"><tt>ntp-keygen</tt></a> page.<dt><tt>sign <i>file</i></tt>
					<dd>Specifies the location of the optional sign key file. This overrides the link <tt>ntpkey_sign_<i>hostname</i></tt> in the keys directory. If this file is not found, the host key is also the sign key.
				</dl>
			<dt><tt>keys <i>keyfile</i></tt>
			<dd>Specifies the complete path and location of the MD5 key file containing the keys and key identifiers used by <tt>ntpd</tt>, <tt>ntpq</tt> and <tt>ntpdc</tt> when operating with symmetric key cryptography. This is the same operation as the <tt>-k </tt>command line option.
			<dt><tt>keysdir <i>path</i></tt>
			<dd>This command specifies the default directory path for cryptographic keys, parameters and certificates. The default is <tt>/usr/local/etc/</tt>.
			<dt><tt>requestkey <i>key</i></tt>
			<dd>Specifies the key identifier to use with the <a href="ntpdc.html"><tt>ntpdc</tt></a> utility program, which uses a proprietary protocol specific to this implementation of <tt>ntpd</tt>. The <tt><i>key</i></tt> argument is a key identifier for the trusted key, where the value can be in the range 1 to 65,534, inclusive.
			<dt><tt>revoke [<i>logsec</i>]</tt>
			<dd>Specifies the interval between re-randomization of certain cryptographic values used by the Autokey scheme, as a power of 2 in seconds. These values need to be updated frequently in order to deflect brute-force attacks on the algorithms of the scheme; however, updating some values is a relatively expensive operation. The default interval is 16 (65,536 s or about 18 hours). For poll intervals above the specified interval, the values will be updated for every message sent.
			<dt><tt>trustedkey <i>key</i> [...]</tt>
			<dd>Specifies the key identifiers which are trusted for the purposes of authenticating peers with symmetric key cryptography, as well as keys used by the <tt>ntpq</tt> and <tt>ntpdc</tt> programs. The authentication procedures require that both the local and remote servers share the same key and key identifier for this purpose, although different keys can be used with different servers. The <tt><i>key</i></tt> arguments are 32-bit unsigned integers with values from 1 to 65,534.
		</dl>
		<h4 id="err">Error Codes</h4>
		<p>Errors can occur due to mismatched configurations, unexpected restarts, expired certificates and unfriendly people. In most cases the protocol state machine recovers automatically by retransmission, timeout and restart, where necessary. Some errors are due to mismatched keys, digest schemes or identity schemes and must be corrected by installing the correct media and/or correcting the configuration file. One of the most common errors is expired certificates, which must be regenerated and signed at least once per year using the <tt><a href="keygen.html">ntp-keygen</a></tt> program.</p>
		<p>The following error codes are reported via the NTP control and monitoring protocol trap mechanism.</p>
		<dl>
			<dt>101 (bad field format or length)
			<dd>The packet has invalid version, length or format.
			<dt>102 (bad timestamp)
			<dd>The packet timestamp is the same or older than the most recent received. This could be due to a replay or a server clock time step.
			<dt>103 (bad filestamp)
			<dd>The packet filestamp is the same or older than the most recent received. This could be due to a replay or a key file generation error.
			<dt>104 (bad or missing public key)
			<dd>The public key is missing, has incorrect format or is an unsupported type.
			<dt>105 (unsupported digest type)
			<dd>The server requires an unsupported digest/signature scheme.
			<dt>106 (unsupported identity type)<dd>The client or server has requested an identity scheme the other does not support.<dt>107 (bad signature length)
			<dd>The signature length does not match the current public key.
			<dt>108 (signature not verified)
			<dd>The message fails the signature check. It could be bogus or signed by a different private key.
			<dt>109 (certificate not verified)
			<dd>The certificate is invalid or signed with the wrong key.<dt>110 (host certificate expired)<dd>The old server certificate has expired.<dt>111 (bad or missing cookie)
			<dd>The cookie is missing, corrupted or bogus.
			<dt>112 (bad or missing leapseconds table)
			<dd>The leapseconds table is missing, corrupted or bogus.
			<dt>113 (bad or missing certificate)
			<dd>The certificate is missing, corrupted or bogus.
			<dt>114 (bad or missing group key)<dd>The identity key is missing, corrupt or bogus.
		
			<dt>115 (protocol error)
			<dd>The protocol state machine has wedged due to unexpected restart
			<dt>116 (server certificate expired)
			<dd>The old server certificate has expired.
		</dl>
		<h4 id="file">Files</h4>
		<p>See the <a href="keygen.html"><tt>ntp-keygen</tt></a> page. Note that provisions to load leap second values from the NIST files have been removed. These provisions are now available whether or not the OpenSSL&nbsp;library is available. However, the functions that can download these values from servers remains available.</p>
		<hr>
		<script type="text/javascript" language="javascript" src="scripts/footer.txt"></script>
	</body>

</html>